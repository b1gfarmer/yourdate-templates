<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Зоны с перетаскиванием гостей</title>
<style>
  body {
    font-family: sans-serif;
    margin: 10px;
    display: flex;
    height: 100vh;
    box-sizing: border-box;
  }
  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-right: 10px;
  }
  #controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  #canvas {
    position: relative;
    flex: 1;
    border: 1px solid #ccc;
    overflow: auto;
  }
  .zone {
    position: absolute;
    border: 1px solid black;
    padding: 8px;
    background: #f0f0f0;
    cursor: grab;
    user-select: none;
    min-width: 150px;
    min-height: 100px;
    box-sizing: border-box;
  }
  .zone input {
    font-weight: bold;
    width: 100%;
    border: none;
    background: transparent;
    margin-bottom: 5px;
  }
  .zone input:focus {
    outline: 1px solid #666;
    background: white;
  }
  .close-btn {
    cursor: pointer;
    font-weight: bold;
    margin-left: 6px;
  }
  #itemsContainer {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    max-width: 100%;
  }
  .draggable-item {
    flex: 0 0 auto;
    padding: 6px 12px;
    border: 1px solid #666;
    border-radius: 4px;
    background: #ddd;
    user-select: none;
    cursor: grab;
    white-space: nowrap;
  }
  .draggable-item:active {
    cursor: grabbing;
  }
  .guest-item {
    margin: 4px 0;
    padding: 4px 6px;
    background: #fff;
    border: 1px solid #999;
    border-radius: 3px;
    cursor: grab;
    user-select: none;
    white-space: nowrap;
  }
  .guest-item[data-type="presidium"] {
    background-color: #ffd;
  }

  /* Панель гостей справа */
  #guestPanel {
    width: 220px;
    border: 1px solid #ccc;
    padding: 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow-y: auto;
  }
  #guestPanel h3 {
    margin-top: 0;
  }
  #addGuestBtn {
    margin-bottom: 10px;
    padding: 6px 12px;
    cursor: pointer;
  }
  #guestList {
    flex: 1;
    overflow-y: auto;
  }
</style>
</head>
<body>

<div id="main">
  <div id="controls">
    <button id="addZoneBtn">Добавить зону</button>
    <div id="itemsContainer">
      <div class="draggable-item" draggable="true" data-id="presidium" data-type="presidium">Президиум</div>
      <div class="draggable-item" draggable="true" data-id="tableA" data-type="table" data-name="Стол A">Стол A</div>
      <div class="draggable-item" draggable="true" data-id="tableB" data-type="table" data-name="Стол B">Стол B</div>
      <div class="draggable-item" draggable="true" data-id="tableC" data-type="table" data-name="Стол C">Стол C</div>
      <div class="draggable-item" draggable="true" data-id="tableD" data-type="table" data-name="Стол D">Стол D</div>
      <div class="draggable-item" draggable="true" data-id="tableE" data-type="table" data-name="Стол E">Стол E</div>
    </div>
  </div>
  <div id="canvas"></div>
</div>

<div id="guestPanel">
  <h3>Список гостей</h3>
  <button id="addGuestBtn">Добавить гостя +</button>
  <div id="guestList">
    <!-- Здесь будут гости -->
  </div>
</div>

<script>
  const canvas = document.getElementById('canvas');
  const addZoneBtn = document.getElementById('addZoneBtn');
  const itemsContainer = document.getElementById('itemsContainer');

  const guestList = document.getElementById('guestList');
  const addGuestBtn = document.getElementById('addGuestBtn');

  let currentTableCharCode = 'F'.charCodeAt(0); // Следующая буква после E
  let guestIdCounter = 1;

  function generateNextTable() {
    const char = String.fromCharCode(currentTableCharCode);
    const id = 'table' + char;
    const name = 'Стол ' + char;

    const newItem = document.createElement('div');
    newItem.className = 'draggable-item';
    newItem.draggable = true;
    newItem.dataset.id = id;
    newItem.dataset.type = 'table';
    newItem.dataset.name = name;
    newItem.textContent = name;

    newItem.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('id', newItem.dataset.id);
      e.dataTransfer.setData('type', newItem.dataset.type);
      e.dataTransfer.setData('name', newItem.dataset.name);
    });

    itemsContainer.appendChild(newItem);

    currentTableCharCode++;
  }

  let zoneCount = 0;
  const zones = [];

  // Хранит id элементов, которые сейчас добавлены в зоны, чтобы не дублировать в источнике
  const addedItems = new Set();

  function createZone(name, x, y) {
    const zone = document.createElement('div');
    zone.className = 'zone';
    zone.style.left = x + 'px';
    zone.style.top = y + 'px';

    const input = document.createElement('input');
    input.type = 'text';
    input.value = name;
    input.title = 'Переименовать зону';

    const closeBtn = document.createElement('span');
    closeBtn.textContent = '✖';
    closeBtn.className = 'close-btn';
    closeBtn.title = 'Удалить зону';

    closeBtn.onclick = () => {
      // При удалении зоны возвращаем элементы обратно в источник и гостей
      const guests = zone.querySelectorAll('.guest-item');
      guests.forEach(guest => {
        const id = guest.dataset.id;
        if (id) {
          addedItems.delete(id);
          restoreItemToSource(id);
        }
      });

      canvas.removeChild(zone);
      const index = zones.indexOf(zone);
      if (index > -1) zones.splice(index, 1);
    };

    zone.appendChild(input);
    zone.appendChild(closeBtn);

    // Контейнер для гостевых объектов (президиум, столы, гости)
    const guestsContainer = document.createElement('div');
    guestsContainer.className = 'guests-container';
    zone.appendChild(guestsContainer);

    // Drag logic for zones (перемещение зон)
    let offsetX, offsetY, dragging = false;

    zone.addEventListener('mousedown', (e) => {
      if (e.target === input || e.target === closeBtn || e.target.parentNode === guestsContainer) return;
      dragging = true;
      offsetX = e.clientX - zone.offsetLeft;
      offsetY = e.clientY - zone.offsetTop;
      zone.style.cursor = 'grabbing';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      let newX = e.clientX - offsetX;
      let newY = e.clientY - offsetY;

      // Ограничения по границам canvas
      newX = Math.max(0, Math.min(newX, canvas.clientWidth - zone.offsetWidth));
      newY = Math.max(0, Math.min(newY, canvas.clientHeight - zone.offsetHeight));

      zone.style.left = newX + 'px';
      zone.style.top = newY + 'px';
    });

    document.addEventListener('mouseup', () => {
      if (dragging) {
        dragging = false;
        zone.style.cursor = 'grab';
      }
    });

    // Поддержка дропа гостей в зону
    zone.addEventListener('dragover', (e) => {
      e.preventDefault();
      zone.style.background = '#e6f7ff';
    });
    zone.addEventListener('dragleave', (e) => {
      zone.style.background = '#f0f0f0';
    });
    zone.addEventListener('drop', (e) => {
      e.preventDefault();
      zone.style.background = '#f0f0f0';

      const id = e.dataTransfer.getData('id');
      const type = e.dataTransfer.getData('type');
      const name = e.dataTransfer.getData('name') || '';

      if (!id || !type) return;
      if (addedItems.has(id)) {
        alert('Этот элемент уже добавлен в зону');
        return;
      }

      // Если это президиум — проверяем есть ли он уже
      if(type === 'presidium') {
        if (guestsContainer.querySelector('.guest-item[data-type="presidium"]')) {
          alert('В зоне уже есть президиум');
          return;
        }
      }

      const guestDiv = document.createElement('div');
      guestDiv.className = 'guest-item';
      guestDiv.textContent = type === 'presidium' ? 'Президиум' : name;
      guestDiv.dataset.type = type;
      guestDiv.dataset.id = id;

      // Добавляем возможность удалить элемент из зоны (двойной клик)
      guestDiv.title = 'Двойной клик — удалить из зоны';
      guestDiv.addEventListener('dblclick', () => {
        guestsContainer.removeChild(guestDiv);
        addedItems.delete(id);
        restoreItemToSource(id);
      });

      guestsContainer.appendChild(guestDiv);

      const closeBtn = document.createElement('span');
      closeBtn.textContent = '✖';
      closeBtn.style.cursor = 'pointer';
      closeBtn.style.color = 'red';
      closeBtn.style.marginLeft = '6px';
      closeBtn.title = 'Удалить элемент из зоны';

      closeBtn.addEventListener('click', () => {
        guestsContainer.removeChild(guestDiv);
        addedItems.delete(id);
        restoreItemToSource(id);
      });
      guestDiv.appendChild(closeBtn);

      addedItems.add(id);

      // Скрываем элемент из источника (гость или элемент)
      hideItemInSource(id);

      // Если это стол — создаём новый стол в списке
      if (type === 'table') {
        generateNextTable();
      }
    });

    return zone;
  }

  addZoneBtn.addEventListener('click', () => {
    const name = 'Зона ' + String.fromCharCode(65 + zoneCount);
    const margin = 10;
    const y = margin + zoneCount * 120;

    // Центрируем по горизонтали с учётом ширины зоны (150px)
    const x = Math.floor((canvas.clientWidth - 150) / 2);

    const zone = createZone(name, x, y);
    canvas.appendChild(zone);
    zones.push(zone);
    zoneCount++;
  });

  // Drag & drop logic for items
  function makeDraggable(item) {
    item.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('id', item.dataset.id);
      e.dataTransfer.setData('type', item.dataset.type);
      e.dataTransfer.setData('name', item.dataset.name || '');
    });
  }

  // Инициализация элементов-источников
  document.querySelectorAll('.draggable-item').forEach(makeDraggable);

  // Панель гостей — добавление гостя
  function createGuest(name) {
    const id = 'guest' + guestIdCounter++;
    const guestDiv = document.createElement('div');
    guestDiv.className = 'guest-item';
    guestDiv.draggable = true;
    guestDiv.textContent = name;
    guestDiv.dataset.type = 'guest';
    guestDiv.dataset.id = id;

    guestDiv.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('id', id);
      e.dataTransfer.setData('type', 'guest');
      e.dataTransfer.setData('name', name);
    });

    guestDiv.title = 'Перетащите гостя в зону';

    // Двойной клик — удаление гостя из панели, если он не в зоне
    guestDiv.addEventListener('dblclick', () => {
      if (addedItems.has(id)) {
        alert('Этот гость уже в зоне, удалите его там.');
        return;
      }
      guestList.removeChild(guestDiv);
    });

    guestList.appendChild(guestDiv);
  }

  addGuestBtn.addEventListener('click', () => {
    const guestName = prompt('Введите имя гостя:', 'Гость ' + guestIdCounter);
    if (!guestName) return;
    createGuest(guestName);
  });

  // По умолчанию создадим несколько гостей
  ['Иван', 'Мария', 'Алексей', 'Ольга'].forEach(createGuest);

  // Скрытие элементов из источника при добавлении в зону
  function hideItemInSource(id) {
    // Ищем среди гостей
    const guest = guestList.querySelector(`[data-id="${id}"]`);
    if (guest) {
      guest.style.display = 'none';
      return;
    }
    // Ищем среди элементов в itemsContainer
    const elem = itemsContainer.querySelector(`[data-id="${id}"]`);
    if (elem) {
      elem.style.display = 'none';
    }
  }
  // Восстановление элемента в источнике при удалении из зоны
  function restoreItemToSource(id) {
    const guest = guestList.querySelector(`[data-id="${id}"]`);
    if (guest) {
      guest.style.display = '';
      return;
    }
    const elem = itemsContainer.querySelector(`[data-id="${id}"]`);
    if (elem) {
      elem.style.display = '';
    }
  }

</script>

</body>
</html>
